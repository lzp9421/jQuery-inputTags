
!function(a){a.fn.tagEditorInput=function(){var c=" ",f=a(this),g=parseInt(f.css("fontSize")),b=a("<span/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:f.css("fontSize"),fontFamily:f.css("fontFamily"),fontWeight:f.css("fontWeight"),letterSpacing:f.css("letterSpacing"),whiteSpace:"nowrap"}),d=function(){if(c!==(c=f.val())){b.text(c);var e=b.width()+g;20>e&&(e=20),e!=f.width()&&f.width(e)}};return b.insertAfter(f),f.bind("keyup keydown focus",d)};a.fn.tagEditor=function(d,j,h){function e(k){return k.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}var g,f=a.extend({},a.fn.tagEditor.defaults,d),b=this;f.dregex=new RegExp("["+f.delimiter.replace("-","-")+"]","g");if(typeof d=="string"){var c=[];b.each(function(){var l=a(this),m=l.data("options"),k=l.next(".tag-editor");if(d=="getTags"){c.push({field:l[0],editor:k,tags:k.data("tags")})}else{if(d=="addTag"){if(m.maxTags&&k.data("tags").length>=m.maxTags){return false}a('<li><div class="tag-editor-spacer">&nbsp;'+m.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(k).find(".tag-editor-tag").html('<input type="text" maxlength="'+m.maxLength+'">').addClass("active").find("input").val(j).blur();if(!h){k.click()}else{a(".placeholder",k).remove()}}else{if(d=="removeTag"){a(".tag-editor-tag",k).filter(function(){return a(this).text()==j}).closest("li").find(".tag-editor-delete").click();if(!h){k.click()}}else{if(d=="destroy"){l.removeClass("tag-editor-hidden-src").removeData("options").off("focus.tag-editor").next(".tag-editor").remove()}}}}});return d=="getTags"?c:this}if(window.getSelection){a(document).off("keydown.tag-editor").on("keydown.tag-editor",function(p){if(p.which==8||p.which==46||p.ctrlKey&&p.which==88){try{var n=getSelection(),m=document.activeElement.tagName=="BODY"?a(n.getRangeAt(0).startContainer.parentNode).closest(".tag-editor"):0}catch(p){m=0}if(n.rangeCount>0&&m&&m.length){var l=[],o=n.toString().split(m.prev().data("options").dregex);for(i=0;i<o.length;i++){var k=a.trim(o[i]);if(k){l.push(k)}}a(".tag-editor-tag",m).each(function(){if(~a.inArray(a(this).text(),l)){a(this).closest("li").find(".tag-editor-delete").click()}});return false}}})}return b.each(function(){var l=a(this),t=[];var q=a("<ul "+(f.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(l);l.addClass("tag-editor-hidden-src").data("options",f).on("focus.tag-editor",function(){q.click()});q.append('<li style="width:1px">&nbsp;</li>');var o='<li><div class="tag-editor-spacer">&nbsp;'+f.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';function m(){if(f.placeholder&&!t.length&&!a(".deleted, .placeholder, input",q).length){q.append('<li class="placeholder"><div>'+f.placeholder+"</div></li>")}}function s(x){var w=t.toString();t=a(".tag-editor-tag:not(.deleted)",q).map(function(y,z){var A=a.trim(a(this).hasClass("active")?a(this).find("input").val():a(z).text());if(A){return A}}).get();q.data("tags",t);l.val(t.join(f.delimiter[0]));if(!x){if(w!=t.toString()){f.onChange(l,q,t)}}m()}q.click(function(x,w){var A,z=99999,y;if(window.getSelection&&getSelection()!=""){return}if(f.maxTags&&q.data("tags").length>=f.maxTags){q.find("input").blur();return false}g=true;a("input:focus",q).blur();if(!g){return false}g=true;a(".placeholder",q).remove();if(w&&w.length){y="before"}else{a(".tag-editor-tag",q).each(function(){var B=a(this),E=B.offset(),D=E.left,C=E.top;if(x.pageY>=C&&x.pageY<=C+B.height()){if(x.pageX<D){y="before",A=D-x.pageX}else{y="after",A=x.pageX-D-B.width()}if(A<z){z=A,w=B}}})}if(y=="before"){a(o).insertBefore(w.closest("li")).find(".tag-editor-tag").click()}else{if(y=="after"){a(o).insertAfter(w.closest("li")).find(".tag-editor-tag").click()}else{a(o).appendTo(q).find(".tag-editor-tag").click()}}return false});q.on("click",".tag-editor-delete",function(y){if(a(this).prev().hasClass("active")){a(this).closest("li").find("input").caret(-1);return false}var x=a(this).closest("li"),w=x.find(".tag-editor-tag");if(f.beforeTagDelete(l,q,t,w.text())===false){return false}w.addClass("deleted").animate({width:0},f.animateDelete,function(){x.remove();m()});s();return false});if(f.clickDelete){q.on("mousedown",".tag-editor-tag",function(y){if(y.ctrlKey||y.which>1){var x=a(this).closest("li"),w=x.find(".tag-editor-tag");if(f.beforeTagDelete(l,q,t,w.text())===false){return false}w.addClass("deleted").animate({width:0},f.animateDelete,function(){x.remove();m()});s();return false}})}q.on("click",".tag-editor-tag",function(C){if(f.clickDelete&&(C.ctrlKey||C.which>1)){return false}if(!a(this).hasClass("active")){var y=a(this).text();var B=Math.abs((a(this).offset().left-C.pageX)/a(this).width()),x=parseInt(y.length*B),z=a(this).html('<input type="text" maxlength="'+f.maxLength+'" value="'+e(y)+'">').addClass("active").find("input");z.data("old_tag",y).tagEditorInput().focus().caret(x);if(f.autocomplete){var A=a.extend({},f.autocomplete);var w="select" in A?f.autocomplete.select:"";A.select=function(E,D){if(w){w(E,D)}setTimeout(function(){q.trigger("click",[a(".active",q).find("input").closest("li").next("li").find(".tag-editor-tag")])},20)};z.autocomplete(A)}}return false});function k(y){var w=y.closest("li"),C=y.val().replace(/ +/," ").split(f.dregex),B=y.data("old_tag"),x=t.slice(0),D=false,A;for(var z=0;z<C.length;z++){u=a.trim(C[z]).slice(0,f.maxLength);if(f.forceLowercase){u=u.toLowerCase()}A=f.beforeTagSave(l,q,x,B,u);u=A||u;if(A===false||!u){continue}if(f.removeDuplicates&&~a.inArray(u,x)){a(".tag-editor-tag",q).each(function(){if(a(this).text()==u){a(this).closest("li").remove()}})}x.push(u);w.before('<li><div class="tag-editor-spacer">&nbsp;'+f.delimiter[0]+'</div><div class="tag-editor-tag">'+e(u)+'</div><div class="tag-editor-delete"><i></i></div></li>');if(f.maxTags&&x.length>=f.maxTags){D=true;break}}y.attr("maxlength",f.maxLength).removeData("old_tag").val("");if(D){y.blur()}else{y.focus()}s()}q.on("blur","input",function(z){z.stopPropagation();var x=a(this),y=x.data("old_tag"),w=a.trim(x.val().replace(/ +/," ").replace(f.dregex,f.delimiter[0]));if(!w){if(y&&f.beforeTagDelete(l,q,t,y)===false){x.val(y).focus();g=false;s();return}try{x.closest("li").remove()}catch(z){}if(y){s()}}else{if(w.indexOf(f.delimiter[0])>=0){k(x);return}else{if(w!=y){if(f.forceLowercase){w=w.toLowerCase()}cb_val=f.beforeTagSave(l,q,t,y,w);w=cb_val||w;if(cb_val===false){if(y){x.val(y).focus();g=false;s();return}try{x.closest("li").remove()}catch(z){}if(y){s()}}else{if(f.removeDuplicates){a(".tag-editor-tag:not(.active)",q).each(function(){if(a(this).text()==w){a(this).closest("li").remove()}})}}}}}x.parent().html(e(w)).removeClass("active");if(w!=y){s()}m()});var p;q.on("paste","input",function(w){a(this).removeAttr("maxlength");p=a(this);setTimeout(function(){k(p)},30)});var r;q.on("keypress","input",function(w){if(f.delimiter.indexOf(String.fromCharCode(w.which))>=0){r=a(this);setTimeout(function(){k(r)},20)}});q.on("keydown","input",function(w){var z=a(this);if((w.which==37||!f.autocomplete&&w.which==38)&&!z.caret()||w.which==8&&!z.val()){var y=z.closest("li").prev("li").find(".tag-editor-tag");if(y.length){y.click().find("input").caret(-1)}else{if(z.val()&&!(f.maxTags&&q.data("tags").length>=f.maxTags)){a(o).insertBefore(z.closest("li")).find(".tag-editor-tag").click()}}return false}else{if((w.which==39||!f.autocomplete&&w.which==40)&&(z.caret()==z.val().length)){var x=z.closest("li").next("li").find(".tag-editor-tag");if(x.length){x.click().find("input").caret(0)}else{if(z.val()){q.click()}}return false}else{if(w.which==9){if(w.shiftKey){var y=z.closest("li").prev("li").find(".tag-editor-tag");if(y.length){y.click().find("input").caret(0)}else{if(z.val()&&!(f.maxTags&&q.data("tags").length>=f.maxTags)){a(o).insertBefore(z.closest("li")).find(".tag-editor-tag").click()}else{l.attr("disabled","disabled");setTimeout(function(){l.removeAttr("disabled")},30);return}}return false}else{var x=z.closest("li").next("li").find(".tag-editor-tag");if(x.length){x.click().find("input").caret(0)}else{if(z.val()){q.click()}else{return}}return false}}else{if(w.which==46&&(!a.trim(z.val())||(z.caret()==z.val().length))){var x=z.closest("li").next("li").find(".tag-editor-tag");if(x.length){x.click().find("input").caret(0)}else{if(z.val()){q.click()}}return false}else{if(w.which==13){q.trigger("click",[z.closest("li").next("li").find(".tag-editor-tag")]);if(f.maxTags&&q.data("tags").length>=f.maxTags){q.find("input").blur()}return false}else{if(w.which==36&&!z.caret()){q.find(".tag-editor-tag").first().click()}else{if(w.which==35&&z.caret()==z.val().length){q.find(".tag-editor-tag").last().click()}else{if(w.which==27){z.val(z.data("old_tag")?z.data("old_tag"):"").blur();return false}}}}}}}}});var v=f.initialTags.length?f.initialTags:l.val().split(f.dregex);for(var n=0;n<v.length;n++){if(f.maxTags&&n>=f.maxTags){break}var u=a.trim(v[n].replace(/ +/," "));if(u){if(f.forceLowercase){u=u.toLowerCase()}t.push(u);q.append('<li><div class="tag-editor-spacer">&nbsp;'+f.delimiter[0]+'</div><div class="tag-editor-tag">'+e(u)+'</div><div class="tag-editor-delete"><i></i></div></li>')}}s(true);if(f.sortable&&a.fn.sortable){q.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){s()}})}})};a.fn.tagEditor.defaults={initialTags:[],maxTags:0,maxLength:50,delimiter:",;",placeholder:"",forceLowercase:true,removeDuplicates:true,clickDelete:false,animateDelete:175,sortable:true,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}};Array.prototype.each=function(f){f=f||Function.K;var b=[];var c=Array.prototype.slice.call(arguments,1);for(var e=0;e<this.length;e++){var d=f.apply(this,[this[e],e].concat(c));if(d!==null){b.push(d)}}return b};Array.prototype.contains=function(c){for(var b=0;b<this.length;b++){if(this[b]===c){return true}}return false};Array.prototype.uniquelize=function(){var c=new Array();for(var b=0;b<this.length;b++){if(!c.contains(this[b])){c.push(this[b])}}return c};Array.complement=function(d,c){return Array.minus(Array.union(d,c),Array.intersect(d,c))};Array.intersect=function(d,c){return d.uniquelize().each(function(b){return c.contains(b)?b:null})};Array.minus=function(d,c){return d.uniquelize().each(function(b){return c.contains(b)?null:b})};Array.union=function(d,c){return d.concat(c).uniquelize()};a.extend({inputTags:function(m,c,e){var h=a("#"+m.inputId);var b=a("#"+m.panelId);var g=m.selectedTags||[];var l=m.allTags||[];var f=m.beforeTagSave;var k=m.beforeTagDelete;delete m.inputId;delete m.panelId;delete m.selectedTags;delete m.allTags;var d=function(r,q,n){var p=r.find("span:contains("+q+")");p.each(function(o,s){if(a(s).text()===q){a(s).siblings('input[type="checkbox"]').prop("checked",n)}})};m.beforeTagSave=function(q,p,o,n,r){n&&d(b,n,false);r&&d(b,r,true);f&&f(q,p,o,r)};m.beforeTagDelete=function(p,o,n,q){d(b,q,false);k&&k(p,o,n,q)};m.initialTags=g=Array.intersect(g,l);h.tagEditor(m,c,e);var j=function(p){var n;for(var q=0;q<p.length;q++){n=p[q];var o=a("<label>").attr("for","label-"+q);var s=a("<input>").attr("type","checkbox").attr("id","label-"+q).css("display","none");var r=a("<span>").addClass("label label-info").text(n);b.append(o.append(s,r))}};j(l);b.find('input[type="checkbox"]').on("change",function(){var n=a(this).siblings("span").text();if(a(this).is(":checked")){h.tagEditor("addTag",n)}else{h.tagEditor("removeTag",n)}})}})}(jQuery);